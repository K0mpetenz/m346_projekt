#cloud-config

# Pakete aktualisieren
package_update: true
package_upgrade: true

# MySQL Setup-Skript erstellen
write_files:
  - path: /root/setup_mysql.sh
    permissions: '0755'
    owner: root:root
    content: |
      #!/bin/bash
      
      # Variablen
      DB_PASS="Passwort123!"
      
      # MySQL Repo hinzufügen
      echo "MySQL Repo wird hinzugefügt..."
      yum install -y https://dev.mysql.com/get/mysql80-community-release-el7-5.noarch.rpm
      
      # MySQL Server installieren
      echo "MySQL Server wird installiert..."
      yum install -y mysql-community-server
      
      # MySQL starten und aktivieren
      echo "MySQL wird gestartet..."
      systemctl start mysqld
      sleep 25
      systemctl enable mysqld
      
      # Temporäres Root-Passwort aus Log extrahieren
      echo "Temporäres Passwort wird ausgelesen..."
      TEMP_PASSWORT=$(grep 'temporary password' /var/log/mysqld.log | awk '{print $NF}')
      
      if [ -z "$TEMP_PASSWORT" ]; then
        echo "FEHLER: Temporäres Passwort konnte nicht gefunden werden!"
        exit 1
      fi
      
      echo "Root-Passwort wird geändert..."
      mysql -u root -p"$TEMP_PASSWORT" --connect-expired-password \
        -e "ALTER USER 'root'@'localhost' IDENTIFIED BY 'MySecretPass123!';" 2>/dev/null
      
      # Datenbank erstellen
      echo "Datenbank wird erstellt..."
      mysql -u root -p"MySecretPass123!" -e "CREATE DATABASE IF NOT EXISTS Nextcloud_DB;"
      
      # Benutzer erstellen und Rechte vergeben
      echo "Benutzer wird erstellt..."
      mysql -u root -p"MySecretPass123!" -e "CREATE USER IF NOT EXISTS 'NC_User'@'%' IDENTIFIED BY 'Passwort123!';"
      mysql -u root -p"MySecretPass123!" -e "GRANT ALL PRIVILEGES ON Nextcloud_DB.* TO 'NC_User'@'%';"
      mysql -u root -p"MySecretPass123!" -e "FLUSH PRIVILEGES;"

      
      echo "MySQL Setup abgeschlossen!"

# Setup-Skript ausführen
runcmd:
  - /root/setup_mysql.sh > /var/log/mysql_setup.log 2>&1