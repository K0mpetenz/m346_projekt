package_update: true
package_upgrade: true

packages:
  - apache2
  - php
  - php-cli
  - php-fpm
  - php-gd
  - php-mysql
  - php-curl
  - php-xml
  - php-zip
  - php-mbstring
  - php-intl
  - php-bcmath
  - php-gmp
  - php-imagick
  - php-apcu
  - php-redis
  - php-opcache
  - php-ldap
  - php-smbclient
  - unzip
  - wget

runcmd:
  - a2enmod proxy_fcgi setenvif
  - a2enconf php*-fpm
  - a2enmod rewrite headers env dir mime

  - wget https://download.nextcloud.com/server/releases/latest.zip -O /tmp/nextcloud.zip
  - unzip /tmp/nextcloud.zip -d /tmp/
  - mv /tmp/nextcloud /var/www/html/

  - chown -R www-data:www-data /var/www/html/nextcloud
  - find /var/www/html/nextcloud/ -type d -exec chmod 750 {} \;
  - find /var/www/html/nextcloud/ -type f -exec chmod 640 {} \;
  - sudo -u www-data touch /var/www/html/nextcloud/.htaccess

  - |
    cat > /etc/apache2/sites-available/nextcloud.conf << 'EOF'
    <VirtualHost *:80>
        ServerName 192.168.104.94
        DocumentRoot /var/www/html/nextcloud

        <Directory /var/www/html/nextcloud/>
            Require all granted
            AllowOverride All
            Options FollowSymLinks MultiViews
        </Directory>

        ErrorLog ${APACHE_LOG_DIR}/nextcloud_error.log
        CustomLog ${APACHE_LOG_DIR}/nextcloud_access.log combined
    </VirtualHost>
    EOF

  - a2ensite nextcloud.conf
  - a2dissite 000-default.conf
  - systemctl reload apache2
  - systemctl restart apache2

final_message: "tbd."
